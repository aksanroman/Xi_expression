---
title: "Analysis and figures for linear regressions for Chr X, Y, and 21"
output: html_notebook
---

#Setup
```{r}
myPath <- #ADD PATH TO GITHUB FOLDER
library("ggplot2")
library("ggrepel")
library("reshape2")
library("deming")

data_summary <- function(x){
  m <- median(x, na.rm=TRUE)
  ymin <- quantile(x, na.rm=TRUE)[2]
  ymax <- quantile(x, na.rm=TRUE)[4]
  test <- c("y"=m,"ymin"=ymin,"ymax"=ymax)
  names(test) <- c("y","ymin","ymax")
  return(test)
}

suppressPackageStartupMessages(library("Vennerable"))
twoGroupVenn_geneNames <- function(setA, setAname, setB, setBname, expGenes, filename){
  #setA = character vector of gene names
  #setAname = label for the venn diagram
  #setB = character vector of gene names
  #setBname = label for the venn diagram
  #expGenes = character vector of expressed genes
  #filename = output filename.pdf for the venn diagram picture
  
  mySet <- list(setA, setB)
  names(mySet) <- c(setAname,setBname)
  myVenn <- Venn(mySet)
   myOverlap <- length(intersect(setA, setB))
  print(paste0("overlap = ", as.character(myOverlap)))
  m <- length(setA)
  print(paste0("marked = ", as.character(m)))
  expGenes <- length(expGenes)
  print(paste0("expressed = ", as.character(expGenes)))
  nonMarked <- (expGenes - m)
  print(paste0("non marked = ", as.character(nonMarked)))
  k <- length(setB)
  print(paste0("number chosen in set b = ", as.character(k)))
  print(phyper(myOverlap -1,m, nonMarked, k, lower.tail=FALSE))
  
  pdf(myVenn, file=filename)
  #plot(myVenn, show = list(SetLabels = TRUE,Faces = FALSE, FaceText = NULL))
  plot(myVenn, show = list(SetLabels = TRUE,Faces = FALSE))
  #plot(myVenn, show = list(SetLabels = FALSE, Faces=FALSE, FaceText=NULL))
  dev.off()
}
```

# Bring in annotations
```{r}
geneAnno <- read.delim(file=paste0(myPath,"Annotations/geneAnno_proteinCoding_all_20210503.txt"), stringsAsFactors = FALSE)

#"Gene" is ensembl for all figures and output!
colnames(geneAnno)[1] <- "Gene"
geneAnno_x <- geneAnno[geneAnno$chr == "chrX",]
geneAnno_y <- geneAnno[geneAnno$chr == "chrY",]
X_genes_all <-as.character(geneAnno_x$Gene)
Y_genes_all <-as.character(geneAnno_y$Gene)
sexChrom_genes <- c(X_genes_all,Y_genes_all)
PAR1_genes <- geneAnno_x[geneAnno_x$start < 2691188,]$Gene
PAR2_genes <- c("SPRY3","VAMP7","IL9R","WASH6P")
PAR_genes_all <- c(PAR1_genes,PAR2_genes)
NPX_genes <- X_genes_all[! X_genes_all %in% PAR_genes_all]
NPY_genes <- Y_genes_all[! Y_genes_all %in% PAR_genes_all]

# Add additional X chr annotations: NPX-NPY pair
ChrX_anno <- read.delim(file=paste0(myPath,"Annotations/ChrX_annotations_NPY.txt"), stringsAsFactors = FALSE)

#Add to geneAnno_x
geneAnno_x <- merge(x=geneAnno_x, y = ChrX_anno[,c("Gene","Human_NPY")], by="Gene", all.x=TRUE)

#Colors for figures
myOrange <- "#d95f0290"
myOrange_100 <- "#d95f02"
myOrange_80 <- "#d95f0280"
myPurple <- "#7570B390"
myGreen_95 <- "#1B9E7795"
chr21Col <- "#DA70D690"
```

# Make tables for lcl and fibroblast linear regression results
```{r}
lcl_res <- read.delim(file=paste0(myPath,"Linear_regressions/LCLs/LCL_regression_results_npx_par.txt"), header = TRUE, stringsAsFactors = FALSE)
colnames(lcl_res)[colnames(lcl_res) %in% "gene"] <- "gene_name.84"
colnames(lcl_res)[2:22] <- paste0(colnames(lcl_res)[2:22],"_LCL")

fib_res <- read.delim(file=paste0(myPath,"Linear_regressions/Fibroblasts/Fib_regression_results_npx_par.txt"), header = TRUE, stringsAsFactors = FALSE)
colnames(fib_res)[colnames(fib_res) %in% "gene"] <- "gene_name.84"
colnames(fib_res)[2:22] <- paste0(colnames(fib_res)[2:22],"_Fib")

#merge 
lcl_fib_res <- merge(x=lcl_res[,c(1:22)], y=fib_res[,c(1:22)], by="gene_name.84", all=TRUE)

#merge with annotations
lcl_fib_res_anno <- merge(x= lcl_fib_res, y=geneAnno_x, by="gene_name.84", all.x = TRUE)

#add region
lcl_fib_res_anno$region <- "NPX"
lcl_fib_res_anno[lcl_fib_res_anno$Gene %in% PAR1_genes, "region"] <- "PAR1"
lcl_fib_res_anno[lcl_fib_res_anno$Gene %in% PAR2_genes, "region"] <- "PAR2"
lcl_fib_res_anno <- lcl_fib_res_anno[! duplicated(lcl_fib_res_anno$Gene),]
rownames(lcl_fib_res_anno) <- lcl_fib_res_anno$Gene

write.table(x=lcl_fib_res_anno, file="table_s2_npx_par_response.txt", quote=FALSE, sep="\t", col.names = TRUE, row.names=FALSE)

#Get rid of BEX1  - outlier!
lcl_fib_res_anno <- lcl_fib_res_anno[! lcl_fib_res_anno$Gene == "BEX1",]

lcl_res_NPY <- read.delim(file="LCLs/LCL_regression_results_npy.txt", header = TRUE, stringsAsFactors = FALSE)
colnames(lcl_res_NPY)[colnames(lcl_res_NPY) %in% "gene"] <- "gene_name.84"
colnames(lcl_res_NPY)[2:22] <- paste0(colnames(lcl_res_NPY)[2:22],"_LCL")

fib_res_NPY <- read.delim(file="Fibroblasts/Fib_regression_results_npy.txt", header = TRUE,  stringsAsFactors = FALSE)
colnames(fib_res_NPY)[colnames(fib_res_NPY) %in% "gene"] <- "gene_name.84"
colnames(fib_res_NPY)[2:22] <- paste0(colnames(fib_res_NPY)[2:22],"_Fib")

lcl_fib_NPY_res <- merge(x=lcl_res_NPY, y=fib_res_NPY, by="gene_name.84", all=TRUE)

lcl_fib_NPY_res_anno <- merge(x=lcl_fib_NPY_res, y=geneAnno_y, by="gene_name.84", all.x=TRUE)
rownames(lcl_fib_NPY_res_anno) <- lcl_fib_NPY_res_anno$Gene

write.table(x=lcl_fib_NPY_res_anno, file="table_s4_npy_response.txt", quote=FALSE, sep="\t", col.names = TRUE, row.names=FALSE)

chr21_res <- read.delim(file=paste0(myPath,"Linear_regressions/Chr21/LCL_regression_results_chr21.txt"), header = TRUE, stringsAsFactors = FALSE)
colnames(chr21_res)[colnames(chr21_res) %in% "gene"] <- "gene_name.84"

chr21_res_anno <- merge(x=chr21_res, y=geneAnno, by="gene_name.84", all.x=TRUE)
write.table(x=chr21_res_anno, file="table_s5_chr21_response.txt", quote=FALSE, sep="\t", col.names = TRUE, row.names=FALSE)
```


# Bring in lcl and fib linear regression results and quantify significant genes
```{r}
lcl_res <- lcl_fib_res_anno[! is.na(lcl_fib_res_anno$x_adj_pval_LCL),]
lcl_res$start <- lcl_res$start / 1000000
lcl_res_NPX <- lcl_res[lcl_res$region %in% "NPX",]
lcl_res_PAR1 <- lcl_res[lcl_res$region %in% c("PAR1"),]
lcl_res_PAR2 <- lcl_res[lcl_res$region %in% c("PAR2"),]
lcl_res_sig <- lcl_res[lcl_res$x_adj_pval_LCL < 0.05,]
lcl_res_NPX_sig <- lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL < 0.05,]
min(lcl_res_NPX_sig$deltaEx_LCL)
max(lcl_res_NPX_sig$deltaEx_LCL)

#number of NPX genes that are not significant
dim(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL>=0.05,])[1]

#number of ChrX genes that are not significant
dim(lcl_res[lcl_res$x_adj_pval_LCL>=0.05,])[1]

#Percent of NPX genes that are not significant
dim(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL>=0.05,])[1]/dim(lcl_res_NPX)[1]

#Percent of Chr X genes that are not significant
dim(lcl_res[lcl_res$x_adj_pval_LCL>=0.05,])[1]/dim(lcl_res)[1]

#Chr X genes significant LCL
dim(lcl_res[lcl_res$x_adj_pval_LCL<0.05,])[1] #122

#Number of NPX genes that are significantly upregulated
dim(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL<0.05 & lcl_res_NPX$deltaEx_LCL>0,])[1]

#Chr X genes
dim(lcl_res[lcl_res$x_adj_pval_LCL<0.05 & lcl_res$deltaEx_LCL>0,])[1]


#Percent of NPX genes that are significantly upregulated
dim(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL<0.05 & lcl_res_NPX$deltaEx_LCL>0,])[1]/dim(lcl_res_NPX)[1]

#Number of NPX genes that are significantly downregulated
dim(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL<0.05 & lcl_res_NPX$deltaEx_LCL<0,])[1]

#Number of Chr X genes that are significantly downregulated
dim(lcl_res[lcl_res$x_adj_pval_LCL<0.05 & lcl_res$deltaEx_LCL<0,])[1]

#Percent of NPX genes that are significantly downregulated
dim(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL<0.05 & lcl_res_NPX$deltaEx_LCL<0,])[1]/dim(lcl_res_NPX)[1]

lcl_res_NPY <- lcl_fib_NPY_res_anno[! is.na(lcl_fib_NPY_res_anno$x_adj_pval_LCL),]
lcl_res_NPY$start <- lcl_res_NPY$start / 1000000

lcl_res_NPY_PAR <- rbind(lcl_res_NPY, lcl_res_PAR1[,colnames(lcl_res_NPY)], lcl_res_PAR2[,colnames(lcl_res_NPY)])

#Num of Chr Y genes sig
dim(lcl_res_NPY_PAR[lcl_res_NPY_PAR$y_adj_pval_LCL < 0.05,])[1]


fib_res <- lcl_fib_res_anno[! is.na(lcl_fib_res_anno$x_adj_pval_Fib),]

fib_res$start <- fib_res$start / 1000000

fib_res_NPX <- fib_res[fib_res$region %in% c("NPX"),]
fib_res_PAR1 <- fib_res[fib_res$region %in% c("PAR1"),]
fib_res_PAR2 <- fib_res[fib_res$region %in% c("PAR2"),]
fib_res_sig <- fib_res[fib_res$x_adj_pval_Fib < 0.05,]
fib_res_NPX_sig <- fib_res_NPX[fib_res_NPX$x_adj_pval_Fib < 0.05,]
min(fib_res_NPX_sig$deltaEx_Fib)
max(fib_res_NPX_sig$deltaEx_Fib)

#number of NPX genes that are not significant
dim(fib_res_NPX[fib_res_NPX$x_adj_pval_Fib>=0.05,])[1]
dim(fib_res[fib_res$x_adj_pval_Fib>=0.05,])[1]

#Percent of NPX genes that are not significant
dim(fib_res_NPX[fib_res_NPX$x_adj_pval_Fib>=0.05,])[1]/dim(fib_res_NPX)[1]

#Percent of ChrX genes that are not significant
dim(fib_res[fib_res$x_adj_pval_Fib>=0.05,])[1]/dim(fib_res)[1]

#number of NPX genes that are significantly upregulated
dim(fib_res_NPX[fib_res_NPX$x_adj_pval_Fib<0.05 & fib_res_NPX$deltaEx_Fib>0,])[1]
dim(fib_res[fib_res$x_adj_pval_Fib<0.05 & fib_res$deltaEx_Fib>0,])[1]

#Number of Chr X genes that are significant:
dim(fib_res[fib_res$x_adj_pval_Fib<0.05 ,])[1]

#percent of NPX genes that are significantly upregulated
dim(fib_res_NPX[fib_res_NPX$x_adj_pval_Fib<0.05 & fib_res_NPX$deltaEx_Fib>0,])[1]/dim(fib_res_NPX)[1]

#number of NPX genes that are significantly downregulated
dim(fib_res_NPX[fib_res_NPX$x_adj_pval_Fib<0.05 & fib_res_NPX$deltaEx_Fib<0,])[1]
dim(fib_res[fib_res$x_adj_pval_Fib<0.05 & fib_res$deltaEx_Fib<0,])[1]


#percent of NPX genes that are significantly downregulated
dim(fib_res_NPX[fib_res_NPX$x_adj_pval_Fib<0.05 & fib_res_NPX$deltaEx_Fib<0,])[1]/dim(fib_res_NPX)[1]

fib_res_NPY_PAR <- rbind(fib_res_NPY, fib_res_PAR1[,colnames(fib_res_NPY)], fib_res_PAR2[,colnames(fib_res_NPY)])


fib_res_NPY <- lcl_fib_NPY_res_anno[! is.na(lcl_fib_NPY_res_anno$x_adj_pval_Fib),]
fib_res_NPY$start <- fib_res_NPY$start / 1000000

fib_res_NPY_PAR <- rbind(fib_res_NPY, fib_res_PAR1[,colnames(fib_res_NPY)], fib_res_PAR2[,colnames(fib_res_NPY)])

#Num of Chr Y genes sig
dim(fib_res_NPY_PAR[fib_res_NPY_PAR$y_adj_pval_LCL < 0.05,])[1]


#Union numbers
NPX_union <- union(lcl_res_NPX$Gene, fib_res_NPX$Gene)
ChrX_union <- union(lcl_res$Gene, fib_res$Gene)
NPY_union <- union(lcl_res_NPY$Gene, fib_res_NPY$Gene)
PAR1_union <- union(lcl_res_PAR1$Gene, fib_res_PAR1$Gene)
PAR2_union <- union(lcl_res_PAR2$Gene, fib_res_PAR2$Gene)

sig_union <- union(lcl_res_sig$Gene, fib_res_sig$Gene)
sig_intersect <- intersect(lcl_res_sig$Gene, fib_res_sig$Gene)

#Overlap of LCL and fib genes
Overlap_NPX_sigup <- intersect(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL < 0.05 & lcl_res_NPX$deltaEx_LCL > 0,"Gene"], fib_res_NPX[fib_res_NPX$x_adj_pval_Fib < 0.05 & fib_res_NPX$deltaEx_Fib > 0,"Gene"])
Overlap_NPX_sigdown <- intersect(lcl_res_NPX[lcl_res_NPX$x_adj_pval_LCL < 0.05 & lcl_res_NPX$deltaEx_LCL < 0,"Gene"], fib_res_NPX[fib_res_NPX$x_adj_pval_Fib < 0.05 & fib_res_NPX$deltaEx_Fib < 0,"Gene"])

#Quantify chr21 results
chr21_res_sig <- chr21_res[chr21_res$chr21_adj_pval < 0.05,]
chr21_res_notsig <- chr21_res[chr21_res$chr21_adj_pval >= 0.05,]

#number of Chr 21 genes that are not significant
dim(chr21_res[chr21_res$chr21_adj_pval>=0.05,])[1]

#percent of Chr 21 genes that are not significant
dim(chr21_res[chr21_res$chr21_adj_pval>=0.05,])[1]/dim(chr21_res)[1]

#number of Chr 21 genes that are significantly upregulated
dim(chr21_res[chr21_res$chr21_adj_pval<0.05 & chr21_res$deltaEchr21>0,])[1]

#percent of Chr 21 genes that are significantly upregulated
dim(chr21_res[chr21_res$chr21_adj_pval<0.05 & chr21_res$deltaEchr21>0,])[1]/dim(chr21_res)[1]

#number of Chr 21 genes that are significantly downregulated
dim(chr21_res[chr21_res$chr21_adj_pval<0.05 & chr21_res$deltaEchr21<0,])[1]

#percent of Chr 21 genes that are significantly downregulated
dim(chr21_res[chr21_res$chr21_adj_pval<0.05 & chr21_res$deltaEchr21<0,])[1]/dim(chr21_res)[1]

```

#Figures 2 and 3
##X Chr volcano plots
```{r}
#I Make volcano plots using deltaEx as the X-axis instead of "fold-change", as is typical.

#color code the points by whether they are 
#1. NPX-NPY
#2. NPX, no Y
#3. PAR

myGenes <- c("PRPS2","XIST","F8")

#Start with LCLs
lcl_res_edit <- lcl_res
lcl_res_edit$label <- "NPX_noY"
lcl_res_edit$label <- as.character(lcl_res_edit$label)
lcl_res_edit[lcl_res_edit$region %in% c("PAR1","PAR2"), "label"] <- "PAR"
lcl_res_edit[lcl_res_edit$Human_NPY == TRUE, "label"] <- "NPX_NPY"
lcl_res_edit$label <- factor(x = lcl_res_edit$label, levels = c("PAR","NPX_noY","NPX_NPY"))

pdf(file="volcano_lcl_Xchrom.pdf", width=6, height=2.5)
ggplot() +
  geom_vline(xintercept=0, size=0.25, lty=2, col="#00000040") +
  geom_vline(xintercept=1, size=0.25, lty=2, col="#00000040") +
  geom_hline(yintercept=(-log10(0.05)), size=0.25, lty=2, col="#00000040") +
  geom_point(data=lcl_res_edit[lcl_res_edit$label == "NPX_noY",], aes(x = deltaEx_LCL, y = -log10(x_adj_pval_LCL)),stroke=0, col=myOrange_80) +
  geom_point(data=lcl_res_edit[lcl_res_edit$label == "NPX_NPY",], aes(x = deltaEx_LCL, y = -log10(x_adj_pval_LCL)),stroke=0.75, pch=21, col="black", fill=myOrange_80) +
  geom_point(data=lcl_res_edit[lcl_res_edit$label == "PAR",], aes(x = deltaEx_LCL, y = -log10(x_adj_pval_LCL)),stroke=0, col=myGreen_95) +
  geom_text_repel(data = lcl_res_edit[lcl_res_edit$Gene %in% myGenes,], mapping = aes(x=deltaEx_LCL, y=-log10(x_adj_pval_LCL),label=Gene),col=myOrange_80, 
                  size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = lcl_res_edit[abs(lcl_res_edit$deltaEx_LCL) >= 0.2 & lcl_res_edit$x_adj_pval_LCL < 0.05 & ! lcl_res_edit$Gene %in% myGenes & lcl_res_edit$label == "NPX_noY",], mapping = aes(x=deltaEx_LCL, y=-log10(x_adj_pval_LCL),label=Gene),col=myOrange_80, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
    geom_text_repel(data = lcl_res_edit[abs(lcl_res_edit$deltaEx_LCL) >= 0.2 & lcl_res_edit$x_adj_pval_LCL < 0.05 & ! lcl_res_edit$Gene %in% myGenes & lcl_res_edit$label == "NPX_NPY",], mapping = aes(x=deltaEx_LCL, y=-log10(x_adj_pval_LCL),label=Gene),col="black", size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = lcl_res_edit[abs(lcl_res_edit$deltaEx_LCL) >= 0.2 & lcl_res_edit$x_adj_pval_LCL < 0.05 & ! lcl_res_edit$Gene %in% myGenes & lcl_res_edit$label == "PAR",], mapping = aes(x=deltaEx_LCL, y=-log10(x_adj_pval_LCL),label=Gene),col=myGreen_95, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) +
  labs(
    y="-log10(FDR)",
    title = "LCLs"
  ) + 
  xlim(-0.39,1.48) + 
  ylim (-0.1,60)
dev.off()

#Next, fibroblasts
fib_res_edit <- fib_res
fib_res_edit$label <- "NPX_noY"
fib_res_edit$label <- as.character(fib_res_edit$label)
fib_res_edit[fib_res_edit$region %in% c("PAR1","PAR2"), "label"] <- "PAR"
fib_res_edit[fib_res_edit$Human_NPY == TRUE, "label"] <- "NPX_NPY"
fib_res_edit$label <- factor(x = fib_res_edit$label, levels = c("PAR","NPX_noY","NPX_NPY"))

pdf(file="volcano_fib_Xchrom.pdf", width=6, height=2.5)
ggplot() +
  geom_vline(xintercept=0, size=0.25, lty=2, col="#00000040") +
  geom_vline(xintercept=1, size=0.25, lty=2, col="#00000040") +
  geom_hline(yintercept=(-log10(0.05)), size=0.25, lty=2, col="#00000040") +
  geom_point(data=fib_res_edit[fib_res_edit$label == "NPX_noY",], aes(x = deltaEx_Fib, y = -log10(x_adj_pval_Fib)),stroke=0, col=myOrange_80) +
  geom_point(data=fib_res_edit[fib_res_edit$label == "NPX_NPY",], aes(x = deltaEx_Fib, y = -log10(x_adj_pval_Fib)),stroke=0.75, pch=21, col="black", fill=myOrange_80) +
  geom_point(data=fib_res_edit[fib_res_edit$label == "PAR",], aes(x = deltaEx_Fib, y = -log10(x_adj_pval_Fib)),stroke=0, col=myGreen_95) +
  geom_text_repel(data = fib_res_edit[fib_res_edit$Gene %in% myGenes,], mapping = aes(x=deltaEx_Fib, y=-log10(x_adj_pval_Fib),label=Gene),col=myOrange_80, 
                  size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = fib_res_edit[abs(fib_res_edit$deltaEx_Fib) >= 0.2 &  fib_res_edit$x_adj_pval_Fib < 0.05 & ! fib_res_edit$Gene %in% myGenes & fib_res_edit$label == "NPX_noY",], mapping = aes(x=deltaEx_Fib, y=-log10(x_adj_pval_Fib),label=Gene),col=myOrange_80, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
    geom_text_repel(data = fib_res_edit[abs(fib_res_edit$deltaEx_Fib) >= 0.2 & fib_res_edit$x_adj_pval_Fib < 0.05 & ! fib_res_edit$Gene %in% myGenes & fib_res_edit$label == "NPX_NPY",], mapping = aes(x=deltaEx_Fib, y=-log10(x_adj_pval_Fib),label=Gene),col="black", size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = fib_res_edit[abs(fib_res_edit$deltaEx_Fib) >= 0.2 & fib_res_edit$x_adj_pval_Fib < 0.05 & ! fib_res_edit$Gene %in% myGenes & fib_res_edit$label == "PAR",], mapping = aes(x=deltaEx_Fib, y=-log10(x_adj_pval_Fib),label=Gene),col=myGreen_95, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) +
  labs(
    y="-log10(FDR)",
    title = "fibs"
  ) + 
  xlim(-0.39,1.48) + 
  ylim (-0.1,40)
dev.off()
```

##Y Chr volcano plots
```{r}
##DO THE Y genes
myGenes_y <- c("KDM5D")

pdf(file="volcano_lcl_Ychrom.pdf", width=2.25, height=1.75)
ggplot() +
    geom_vline(xintercept=0, size=0.25, lty=2, col="#00000040") +
    geom_vline(xintercept=1, size=0.25, lty=2, col="#00000040") +
      geom_hline(yintercept=(-log10(0.05)), size=0.25, lty=2, col="#00000040") +
    geom_point(data=lcl_res_NPY_PAR[lcl_res_NPY_PAR$Gene %in% Y_genes_all,], aes(x = deltaEy_LCL, y = -log10(y_adj_pval_LCL)),stroke=0, col=myPurple) +
  geom_point(data=lcl_res_NPY_PAR[lcl_res_NPY_PAR$Gene %in% PAR_genes_all,], aes(x = deltaEy_LCL, y = -log10(y_adj_pval_LCL)),stroke=0, col=myGreen_95) +
  geom_point(data=lcl_res_NPY_PAR[lcl_res_NPY_PAR$Gene %in% myGenes_y,], aes(x = deltaEy_LCL, y = -log10(y_adj_pval_LCL)),stroke=0, col="black") +
  geom_text_repel(data = lcl_res_NPY_PAR[lcl_res_NPY_PAR$Gene %in% myGenes_y,], mapping = aes(x=deltaEy_LCL, y=-log10(y_adj_pval_LCL),label=Gene),col="black", size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = lcl_res_NPY_PAR[(! lcl_res_NPY_PAR$Gene %in% myGenes_y) & (lcl_res_NPY_PAR$Gene %in% PAR_genes_all) & (lcl_res_NPY_PAR$y_adj_pval_LCL < 0.05),], mapping = aes(x=deltaEy_LCL, y=-log10(y_adj_pval_LCL),label=Gene),col=myGreen_95, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = lcl_res_NPY_PAR[(! lcl_res_NPY_PAR$Gene %in% myGenes_y) & lcl_res_NPY_PAR$Gene %in% Y_genes_all,], mapping = aes(x=deltaEy_LCL, y=-log10(y_adj_pval_LCL),label=Gene),col=myPurple, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) +
  labs(
    y="-log10(FDR)",
    title = "LCLs"
  ) + xlim(-0.1,2) + ylim(0,30)
dev.off()

#Fibroblasts
  
pdf(file="volcano_fib_Ychrom.pdf", width=2.25, height=1.75)
#try plotting from fibs
ggplot() +
    geom_vline(xintercept=0, size=0.25, lty=2, col="#00000040") +
    geom_vline(xintercept=1, size=0.25, lty=2, col="#00000040") +
      geom_hline(yintercept=(-log10(0.05)), size=0.25, lty=2, col="#00000040") +
    geom_point(data=fib_res_NPY_PAR[fib_res_NPY_PAR$Gene %in% Y_genes_all,], aes(x = deltaEy_Fib, y = -log10(y_adj_pval_Fib)),stroke=0, col=myPurple) +
  geom_point(data=fib_res_NPY_PAR[fib_res_NPY_PAR$Gene %in% PAR_genes_all,], aes(x = deltaEy_Fib, y = -log10(y_adj_pval_Fib)),stroke=0, col=myGreen_95) +
  geom_point(data=fib_res_NPY_PAR[fib_res_NPY_PAR$Gene %in% myGenes_y,], aes(x = deltaEy_Fib, y = -log10(y_adj_pval_Fib)),stroke=0, col="black") +
  geom_text_repel(data = fib_res_NPY_PAR[fib_res_NPY_PAR$Gene %in% myGenes_y,], mapping = aes(x=deltaEy_Fib, y=-log10(y_adj_pval_Fib),label=Gene),col="black", size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = fib_res_NPY_PAR[(! fib_res_NPY_PAR$Gene %in% myGenes_y) & (fib_res_NPY_PAR$Gene %in% PAR_genes_all) & (fib_res_NPY_PAR$y_adj_pval_Fib < 0.05),], mapping = aes(x=deltaEy_Fib, y=-log10(y_adj_pval_Fib),label=Gene),col=myGreen_95, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  geom_text_repel(data = fib_res_NPY_PAR[(! fib_res_NPY_PAR$Gene %in% myGenes_y) & fib_res_NPY_PAR$Gene %in% Y_genes_all,], mapping = aes(x=deltaEy_Fib, y=-log10(y_adj_pval_Fib),label=Gene),col=myPurple, size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.1 ) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) +
  labs(
    y="-log10(FDR)",
    title = "fibs"
  ) + xlim(-0.1,2)
dev.off()
```
##Chr 21 volcano plot
```{r}
myGenes <- c("CCT8")

pdf(file="volcano_lcl_chr21.pdf", width=1.5, height=1.75)
#try plotting from chr21s
ggplot(chr21_res_anno, aes(x = deltaEchr21, y = -log10(chr21_adj_pval))) +
  geom_point(col = chr21Col,stroke=0) +
  geom_vline(xintercept=0, size=0.25, lty=2, col="#00000040") + 
    geom_vline(xintercept=1, size=0.25, lty=2, col="#00000040") + 
      geom_hline(yintercept=(-log10(0.05)), size=0.25, lty=2, col="#00000040") + 
  geom_text_repel(data = chr21_res_anno[chr21_res_anno$Gene %in% myGenes,], mapping = aes(x=deltaEchr21, y=-log10(chr21_adj_pval), label=Gene),col="black",  size=1.75, segment.size = 0.25, min.segment.length = 0, show.legend = FALSE,force = 0.5
  ) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) +
  labs(
    y="-log10(FDR)",
    title = "LCLs"
  ) + xlim(-0.6,3.5) + ylim(0,8)
dev.off()
```

##All deltaE violin plots
```{r}
mylist_fib_lcl <- list("L_NPX_noy_x" = data.frame("deltaEx" = lcl_res_NPX[lcl_res_NPX$Human_NPY == FALSE,"deltaEx_LCL"]), "F_NPX_noy_x" = data.frame("deltaEx" = fib_res_NPX[fib_res_NPX$Human_NPY == FALSE,"deltaEx_Fib"]),
                       "L_NPX_NPY_x" = data.frame("deltaEx" = lcl_res_NPX[lcl_res_NPX$Human_NPY == TRUE,"deltaEx_LCL"]), "F_NPX_NPY_x" = data.frame("deltaEx" = fib_res_NPX[fib_res_NPX$Human_NPY == TRUE,"deltaEx_Fib"]),
                       "L_NPY_y"=data.frame("deltaEy" = lcl_res_NPY$deltaEy_LCL),"F_NPY_y"=data.frame("deltaEy" = fib_res_NPY$deltaEy_Fib),"L_PAR1_x"= data.frame("deltaEx"=lcl_res_PAR1$deltaEx_LCL), "F_PAR1_x"= data.frame("deltaEx"=fib_res_PAR1$deltaEx_Fib), "L_PAR1_y"=data.frame("deltaEy"=lcl_res_PAR1$deltaEy_LCL), "F_PAR1_y"=data.frame("deltaEy"=fib_res_PAR1$deltaEy_Fib),"L_PAR2_x"= data.frame("deltaEx"=lcl_res_PAR2$deltaEx_LCL), "F_PAR2_x"= data.frame("deltaEx"=fib_res_PAR2$deltaEx_Fib), "L_PAR2_y"=data.frame("deltaEy"=lcl_res_PAR2$deltaEy_LCL), "F_PAR2_y"=data.frame("deltaEy"=fib_res_PAR2$deltaEy_Fib), "Chr21_x" = chr21_res$deltaEchr21)

myList_fib_lcl_melt <- melt(mylist_fib_lcl)
myList_fib_lcl_melt$L1 <- factor(x=myList_fib_lcl_melt$L1, levels = c("L_NPX_noy_x","F_NPX_noy_x","L_NPX_NPY_x","F_NPX_NPY_x","L_PAR1_x","F_PAR1_x","L_PAR1_y","F_PAR1_y","L_PAR2_x","F_PAR2_x","L_PAR2_y","F_PAR2_y","L_NPY_y","F_NPY_y","Chr21_x"))

pdf(file="allCat_vioplots_lcl_fib.pdf", height=1.75, width=3.3)
ggplot(data=myList_fib_lcl_melt, mapping = aes(x=L1, y=value, fill=L1)) + 
 geom_hline(yintercept = 0, size=0.25, lty=2, col="#00000040") + 
   geom_hline(yintercept = 1, size=0.25, lty=2, col="#00000040") + 
  # geom_jitter(width=0.2,stroke=0, color="#00000080") +
   geom_violin(col="#00000000",scale = "width",) +
   stat_summary(fun.data=data_summary, size=0.25) +
    scale_fill_manual(values = c(myOrange,myOrange,myOrange,myOrange,myGreen_95,myGreen_95,myGreen_95,myGreen_95,myGreen_95,myGreen_95,myGreen_95,myGreen_95, myPurple,myPurple,chr21Col)) +
ylim(-0.5,3) +
theme_classic(base_size = 8) + 
  theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      axis.text.x = element_text(hjust = 0.5),
      legend.position = "none",
      ) +
  labs(
    title="LCLs and Fibs",
    y="deltaE"
  ) 
dev.off()

wilcox.test(x=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "L_NPX_noy_x","value"], y=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "L_NPX_NPY_x","value"])
wilcox.test(x=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "F_NPX_noy_x","value"], y=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "F_NPX_NPY_x","value"])

t.test(x=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "L_PAR1_x","value"], y=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "L_PAR1_y","value"], paired = TRUE)
t.test(x=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "F_PAR1_x","value"], y=myList_fib_lcl_melt[myList_fib_lcl_melt$L1 == "F_PAR1_y","value"], paired = TRUE)

#Get each median
median(lcl_res_NPX[lcl_res_NPX$Human_NPY == FALSE,"deltaEx_LCL"])
median(fib_res_NPX[fib_res_NPX$Human_NPY == FALSE,"deltaEx_Fib"])
median(lcl_res_NPX[lcl_res_NPX$Human_NPY == TRUE,"deltaEx_LCL"])
median(fib_res_NPX[fib_res_NPX$Human_NPY == TRUE,"deltaEx_Fib"])
median(lcl_res_NPY$deltaEy_LCL)
median(fib_res_NPY$deltaEy_Fib)
median(lcl_res_PAR1$deltaEx_LCL)
median(fib_res_PAR1$deltaEx_Fib)
median(lcl_res_PAR1$deltaEy_LCL)
median(fib_res_PAR1$deltaEy_Fib)
median(lcl_res_PAR2$deltaEx_LCL)
median(fib_res_PAR2$deltaEx_Fib)
median(lcl_res_PAR2$deltaEy_LCL)
median(fib_res_PAR2$deltaEy_Fib)
median(chr21_res$deltaEchr21)
```

##Comparing LCL vs Fib deltaEx
```{r}
myGenes <- c("PRPS2","KDM5C","XIST","F8")

#lcl_fib overlap genes
lcl_fib_overlap <- intersect(lcl_res_edit$Gene, fib_res_edit$Gene)
lcl_res_overlap <- lcl_res[lcl_res$Gene %in% lcl_fib_overlap,c("deltaEx_LCL","Gene")]
fib_res_overlap <- fib_res[fib_res$Gene %in% lcl_fib_overlap,c("deltaEx_Fib","Gene")]
lcl_fib_merge <- merge(x=lcl_res_overlap, y=fib_res_overlap, by="Gene")
colnames(lcl_fib_merge) <- c("Gene","LCL_deltaEx","Fib_deltaEx")
lcl_fib_merge <- merge(x=lcl_fib_merge, y=geneAnno_x[,c("Gene","Human_NPY")], all.x = TRUE, by="Gene")


#use deming regression, which models error in both X and Y 
my.deming <- deming(formula = lcl_fib_merge$Fib_deltaEx ~ lcl_fib_merge$LCL_deltaEx)
deming.coeff <- my.deming$coefficients[2]
deming.int <- my.deming$coefficients[1]

#deming doesn't calculate correlation, use pearson
pearson <- cor.test(x = lcl_fib_merge$LCL_deltaEx, y=lcl_fib_merge$Fib_deltaEx, method = "pearson")

#plot all X genes (NPX )
pdf(file="LCL_fib_deltaEx_corrPlot_NPX.pdf", height=2.5, width=2.5)
ggplot() +
  geom_vline(xintercept = 0, lty=3, size=0.25, color="#00000040") +
  geom_hline(yintercept = 0, lty=3, size=0.25,color="#00000040") +
  geom_point(data=lcl_fib_merge[!lcl_fib_merge$Gene %in% PAR_genes_all & lcl_fib_merge$Human_NPY == FALSE,], aes(x = LCL_deltaEx, y = Fib_deltaEx),stroke=0, col=myOrange_80, size=1.5) +
    geom_point(data=lcl_fib_merge[!lcl_fib_merge$Gene %in% PAR_genes_all & lcl_fib_merge$Human_NPY == TRUE,], aes(x = LCL_deltaEx, y = Fib_deltaEx),pch=21,stroke=0.75, col="black", fill=myOrange_80, size=1.5) +
  geom_point(data=lcl_fib_merge[lcl_fib_merge$Gene %in% PAR_genes_all,], aes(x = LCL_deltaEx, y = Fib_deltaEx),stroke=0, col=myGreen_95, size=1.5) +
  geom_abline(slope = deming.coeff, intercept = deming.int, color="black", lty=2, size=0.25) +
geom_text_repel( data = lcl_fib_merge[lcl_fib_merge$Gene %in% myGenes,], aes(x=LCL_deltaEx, y=Fib_deltaEx, label=lcl_fib_merge[lcl_fib_merge$Gene %in% myGenes,"Gene"]), size=1.75, segment.size = 0.25, min.segment.length = 0.1, force=0.5, col=myOrange_80) +
  xlim(-0.5,1.5) +
  ylim(-0.5,1.5) +
  annotate(
      geom = "text", 
      x = -0.5, 
      y = 1.5,
      label = paste0("r=",formatC(x = pearson$estimate, digits = 2),"\nP=",formatC(x=pearson$p.value, digits = 2, format = "e") ),
      hjust = 0, 
      vjust = 1,
      size=2
      ) +
  labs(title="deltaEx")+
theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25)) 
dev.off()
```


##Comparison to XCI Status
```{r}
#Bring in revised XCI status calls!!
revised_XCI_public <- read.delim(file=paste0(myPath,"Allele_specific_expression/20220719_public_AR_annotation_lclFib_exp.txt"), stringsAsFactors = FALSE)
revised_XCI_public_NPX <- revised_XCI_public[revised_XCI_public$Gene %in% NPX_genes,] #409
revised_XCI_public_PAR1 <- revised_XCI_public[revised_XCI_public$Gene %in% PAR1_genes,]
revised_XCI_public_PAR2 <- revised_XCI_public[revised_XCI_public$Gene %in% PAR2_genes,]

subject_genes <- revised_XCI_public_NPX[revised_XCI_public_NPX$Final_XCI_Call %in% "Subject","Gene"]  #313
escape_genes <- revised_XCI_public_NPX[revised_XCI_public_NPX$Final_XCI_Call %in% "Escape","Gene"] #75
noCall_genes <- revised_XCI_public_NPX[revised_XCI_public_NPX$Final_XCI_Call %in% "No call","Gene"] #21

LCL_pos_subject <- lcl_res[lcl_res$Gene %in% subject_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL > 0,]
write.table(LCL_pos_subject, "LCL_dEx_pos_Subject.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)

LCL_pos_noCall <- lcl_res[lcl_res$Gene %in% noCall_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL > 0,]
LCL_neg_noCall <- lcl_res[lcl_res$Gene %in% noCall_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL < 0,]

LCL_pos_esc <- lcl_res[lcl_res$Gene %in% escape_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL > 0,]
write.table(LCL_pos_esc, "LCL_dEx_pos_Escape.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)

LCL_neg <- lcl_res[lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL < 0,]
write.table(LCL_neg, "LCL_neg.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)

LCL_neg_subject <- lcl_res[lcl_res$Gene %in% subject_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL < 0,]

LCL_neg_esc <- lcl_res[lcl_res$Gene %in% escape_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL < 0,]
LCL_notSig_escape <- lcl_res[lcl_res$Gene %in% escape_genes & lcl_res$x_adj_pval_LCL >= 0.05 & ! is.na(lcl_res$x_adj_pval_LCL),]
write.table(LCL_notSig_escape, "LCL_notSig_escape.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)


LCL_pos_PAR1 <- lcl_res[lcl_res$Gene %in% PAR1_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL > 0,]
LCL_pos_PAR2 <- lcl_res[lcl_res$Gene %in% PAR2_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL > 0,]

LCL_neg_PAR1 <- lcl_res[lcl_res$Gene %in% PAR1_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL < 0,]
LCL_neg_PAR2 <- lcl_res[lcl_res$Gene %in% PAR2_genes & lcl_res$x_adj_pval_LCL < 0.05 & ! is.na(lcl_res$x_adj_pval_LCL) & lcl_res$deltaEx_LCL < 0,]


lcl_res[lcl_res$Gene %in% subject_genes,"XCI_anno"] <- "Subject"
lcl_res[lcl_res$Gene %in% escape_genes,"XCI_anno"] <- "Escape"
lcl_res[lcl_res$Gene %in% noCall_genes,"XCI_anno"] <- "No call"
lcl_res[lcl_res$Gene %in% PAR1_genes,"XCI_anno"] <- "PAR1"
lcl_res[lcl_res$Gene %in% PAR2_genes,"XCI_anno"] <- "PAR2"

#### Fib calculations
Fib_pos_subject <- fib_res[fib_res$Gene %in% subject_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib > 0,]
write.table(Fib_pos_subject, "Fib_dEx_pos_Subject.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)

Fib_pos_noCall <- fib_res[fib_res$Gene %in% noCall_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib > 0,]
Fib_neg_noCall <- fib_res[fib_res$Gene %in% noCall_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib < 0,]

Fib_pos_esc <- fib_res[fib_res$Gene %in% escape_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib > 0,]
write.table(Fib_pos_esc, "Fib_dEx_pos_Escape.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)

Fib_neg <- fib_res[fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib < 0,]
write.table(Fib_neg, "Fib_neg.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)

Fib_neg_subject <- fib_res[fib_res$Gene %in% subject_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib < 0,]

Fib_neg_esc <- fib_res[fib_res$Gene %in% escape_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib < 0,]
Fib_notSig_escape <- fib_res[fib_res$Gene %in% escape_genes & fib_res$x_adj_pval_Fib >= 0.05 & ! is.na(fib_res$x_adj_pval_Fib),]
write.table(Fib_notSig_escape, "Fib_notSig_escape.txt", row.names=TRUE, col.names=TRUE, sep="\t", quote=FALSE)


Fib_pos_PAR1 <- fib_res[fib_res$Gene %in% PAR1_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib > 0,]
Fib_pos_PAR2 <- fib_res[fib_res$Gene %in% PAR2_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib > 0,]

Fib_neg_PAR1 <- fib_res[fib_res$Gene %in% PAR1_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib < 0,]
Fib_neg_PAR2 <- fib_res[fib_res$Gene %in% PAR2_genes & fib_res$x_adj_pval_Fib < 0.05 & ! is.na(fib_res$x_adj_pval_Fib) & fib_res$deltaEx_Fib < 0,]


fib_res[fib_res$Gene %in% subject_genes,"XCI_anno"] <- "Subject"
fib_res[fib_res$Gene %in% escape_genes,"XCI_anno"] <- "Escape"
fib_res[fib_res$Gene %in% noCall_genes,"XCI_anno"] <- "No call"
fib_res[fib_res$Gene %in% PAR1_genes,"XCI_anno"] <- "PAR1"
fib_res[fib_res$Gene %in% PAR2_genes,"XCI_anno"] <- "PAR2"


#Get summary of each group
library(dplyr)
lcl_res_sigUp <- lcl_res[lcl_res$deltaEx_LCL > 0 & lcl_res$x_adj_pval_LCL < 0.05,]
lcl_summary_up <- lcl_res_sigUp %>% group_by(XCI_anno) %>% dplyr::summarize(n())
lcl_summary_up$cell_line <- rep(x = "LCL_up",times = dim(lcl_summary_up)[1])

lcl_res_sigDn <- lcl_res[lcl_res$deltaEx_LCL < 0 & lcl_res$x_adj_pval_LCL < 0.05,]
lcl_summary_Dn <- lcl_res_sigDn %>% group_by(XCI_anno) %>% dplyr::summarize(n())
lcl_summary_Dn$cell_line <- rep(x = "LCL_dn",times = dim(lcl_summary_Dn)[1])

lcl_res_NS <- lcl_res[lcl_res$x_adj_pval_LCL >= 0.05,]
lcl_summary_NS <- lcl_res_NS %>% group_by(XCI_anno) %>% dplyr::summarize(n())
lcl_summary_NS$cell_line <- rep(x = "LCL_NS",times = dim(lcl_summary_NS)[1])

lcl_modulated <- c(lcl_res_sigUp[lcl_res_sigUp$XCI_anno == "Subject","Gene"],
                   lcl_res_sigDn[,"Gene"])

fib_res_sigUp <- fib_res[fib_res$deltaEx_Fib > 0 & fib_res$x_adj_pval_Fib < 0.05,]
fib_summary_up <- fib_res_sigUp %>% group_by(XCI_anno) %>% dplyr::summarize(n())
fib_summary_up$cell_line <- rep(x = "Fib_up",times = dim(fib_summary_up)[1])

fib_res_sigDn <- fib_res[fib_res$deltaEx_Fib < 0 & fib_res$x_adj_pval_Fib < 0.05,]
fib_summary_dn <- fib_res_sigDn %>% group_by(XCI_anno) %>% dplyr::summarize(n())
fib_summary_dn$cell_line <- rep(x = "Fib_dn",times = dim(fib_summary_dn)[1])

fib_res_NS <- fib_res[fib_res$x_adj_pval_Fib >= 0.05,]
fib_summary_NS <- fib_res_NS %>% group_by(XCI_anno) %>% dplyr::summarize(n())
fib_summary_NS$cell_line <- rep(x = "Fib_NS",times = dim(fib_summary_NS)[1])

fib_modulated <- c(fib_res_sigUp[fib_res_sigUp$XCI_anno == "Subject","Gene"],
                   fib_res_sigDn[,"Gene"])

#Get modulated gene overlap from public data.
fib_lcl_mod <- union(lcl_modulated, fib_modulated)
fib_lcl_allX <- union(lcl_res$Gene, fib_res$Gene)

length(fib_lcl_mod)/length(fib_lcl_allX)

fib_lcl_esc <- union(LCL_pos_esc$Gene, Fib_pos_esc$Gene)
length(fib_lcl_esc)/length(fib_lcl_allX)

intersect(fib_lcl_mod, fib_lcl_esc)

fib_lcl_EXP <- intersect(lcl_res$Gene, fib_res$Gene)

LCL_pos_mod_lclOnly <- setdiff(lcl_modulated,fib_res$Gene)
fib_pos_mod_fibOnly <- setdiff(fib_modulated,lcl_res$Gene)
twoGroupVenn_geneNames(setA = intersect(lcl_modulated,fib_res$Gene), setAname = "LCL modulated", setB = intersect(fib_modulated,lcl_res$Gene), setBname = "Fib modulated", expGenes = fib_lcl_EXP, filename = "lcl_fib_XCI_modulated_VENN.pdf")

#Get escape gene overlap from public data (including NPX and PAR1 genes)
#First figure out which are exp in fib or lcl only
LCL_pos_esc_par1 <- rbind(LCL_pos_esc, LCL_pos_PAR1)
Fib_pos_esc_par1 <- rbind(Fib_pos_esc, Fib_pos_PAR1)
LCL_pos_esc_lclOnly <- LCL_pos_esc_par1[is.na(LCL_pos_esc_par1$intercept_Fib),"Gene"]
fib_pos_esc_fibOnly <- Fib_pos_esc_par1[is.na(Fib_pos_esc_par1$intercept_LCL),"Gene"]

twoGroupVenn_geneNames(setA = LCL_pos_esc_par1[!is.na(LCL_pos_esc_par1$intercept_Fib),"Gene"], setAname = "LCL escape", setB = Fib_pos_esc_par1[! is.na(Fib_pos_esc_par1$intercept_LCL),"Gene"], setBname = "Fib escape", expGenes = fib_lcl_EXP, filename = "lcl_fib_XCI_Xiexp_VENN.pdf")


lcl_fib_summary <- rbind(lcl_summary_up, lcl_summary_Dn, lcl_summary_NS, fib_summary_up, fib_summary_dn,fib_summary_NS)
colnames(lcl_fib_summary)[2] <- "value"
lcl_fib_summary$XCI_anno <- factor(x = lcl_fib_summary$XCI_anno, levels = c("Escape","PAR1","PAR2","Subject", "No call"))
myCols <- c("#C37B73","#C37B73","#86A3E4", "#86A3E4","#00000050")
lcl_fib_summary$cell_line <- factor(x=lcl_fib_summary$cell_line, levels = c("LCL_up", "LCL_dn","LCL_NS","Fib_up","Fib_dn", "Fib_NS"))
  
# Stacked
pdf("XCI_status_categories_dEX.pdf", width=3.5, height=2.5)
ggplot(lcl_fib_summary, aes(fill=XCI_anno, y=value, x=cell_line)) + 
    geom_bar(position="fill", stat="identity") +
      scale_fill_manual(values = myCols) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25), 
      legend.position = "none")  + labs(title="XCI status", y="Number of genes") 
dev.off()
```

# Linear regression analysis in males or females only
```{r}
#read in regression results
lcl_male_res <- read.delim(file=paste0(myPath,"Linear_regressions/LCLs/Single_sex_regressions/LCL_regression_results_npx_par_MALE.txt"), stringsAsFactors = FALSE)
lcl_female_res <- read.delim(file=paste0(myPath,"Linear_regressions/LCLs/Single_sex_regressions/LCL_regression_results_npx_par_FEMALE.txt"),stringsAsFactors = FALSE)

fib_male_res <- read.delim(file=paste0(myPath,"Linear_regressions/Fibroblasts/Single_sex_regressions/Fib_regression_results_npx_par_MALE.txt"), stringsAsFactors = FALSE)
fib_female_res <- read.delim(file=paste0(myPath,"Linear_regressions/Fibroblasts/Single_sex_regressions/Fib_regression_results_npx_par_FEMALE.txt"), stringsAsFactors = FALSE)

#plot LCL all samples vs female only (45,X; 46,XX; 47,XXX; 48,XXXX) regression
#merge
lcl_all_res_F_res <- merge(x=lcl_res,y=lcl_female_res, by.x="gene_name.84",by.y="gene",all=TRUE)
#remove outlier: MAP7D2
lcl_all_res_F_res <- lcl_all_res_F_res[!lcl_all_res_F_res$Gene == "MAP7D2",]
my.deming <- deming(formula = deltaEx~deltaEx_LCL, data= lcl_all_res_F_res)
my.cor <- cor.test(x = lcl_all_res_F_res$deltaEx_LCL, y=lcl_all_res_F_res$deltaEx, method="pearson")
pdf(file="lcl_x_res_all_vs_F_only.pdf", width=2, height=2)
ggplot() +
  geom_vline(xintercept=0, size=0.25,  col="#00000040") +
  geom_hline(yintercept=0, size=0.25,  col="#00000040") +
  geom_abline(slope=my.deming$coefficients[2], intercept = my.deming$coefficients[1], size=0.25) +
  geom_point(data=lcl_all_res_F_res, aes(x = deltaEx_LCL, y = deltaEx), stroke=0, col="#00000060") +
  geom_text(aes(x=1.5, y=-0.5, label=paste0("P = ",formatC(x=my.cor$p.value,digits=3),"\nr =",formatC(x=my.cor$estimate,digits=2))), size=2,hjust=1,vjust=0) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) + xlim(-0.5,1.5) + ylim(-0.5,1.5) +
  labs(x="deltaEx all samples", y="deltaEx female samples")
dev.off()


#plot LCL all samples vs male only (46,XY; 47,XXY; 48,XXXY, 49,XXXXY)
lcl_all_res_M_res <- merge(x=lcl_res,y=lcl_male_res, by.x="gene_name.84",by.y="gene",all=TRUE)
#remove outlier: PPP2R3B
# lcl_all_res_M_res <- lcl_all_res_M_res[!lcl_all_res_M_res$Gene == "PPP2R3B",]
my.deming <- deming(formula = deltaEx~deltaEx_LCL, data= lcl_all_res_M_res)
my.cor <- cor.test(x = lcl_all_res_M_res$deltaEx_LCL, y=lcl_all_res_M_res$deltaEx, method="pearson")
pdf(file="lcl_x_res_all_vs_M_only.pdf", width=2, height=2)
ggplot() +
  geom_vline(xintercept=0, size=0.25, col="#00000040") +
  geom_hline(yintercept=0, size=0.25,  col="#00000040") +
  geom_abline(slope=my.deming$coefficients[2], intercept = my.deming$coefficients[1], size=0.25) +
  geom_point(data=lcl_all_res_M_res, aes(x = deltaEx_LCL, y = deltaEx), stroke=0, col="#00000060") +
  geom_text(aes(x=1.5, y=-0.5, label=paste0("P = ",formatC(x=my.cor$p.value,digits=3),"\nr =",formatC(x=my.cor$estimate,digits=2))), size=2,hjust=1,vjust=0) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) + xlim(-0.5,1.5) + ylim(-0.5,1.5) +
  labs(x="deltaEx all samples", y="deltaEx male samples")
dev.off()

#plot fib all X vs female only
#merge
fib_all_res_F_res <- merge(x=fib_res,y=fib_female_res, by.x="gene_name.84",by.y="gene",all=TRUE)
fib_all_res_F_res <- fib_all_res_F_res[!fib_all_res_F_res$Gene %in% c("BEX1"),]
my.deming <- deming(formula = deltaEx~deltaEx_Fib, data= fib_all_res_F_res)
my.cor <- cor.test(x = fib_all_res_F_res$deltaEx_Fib, y=fib_all_res_F_res$deltaEx, method="pearson")
pdf(file="fib_x_res_all_vs_F_only.pdf", width=2, height=2)
ggplot() +
  geom_vline(xintercept=0, size=0.25, lty=2, col="#00000040") +
  geom_hline(yintercept=0, size=0.25, lty=2, col="#00000040") +
  geom_abline(slope=my.deming$coefficients[2], intercept = my.deming$coefficients[1], size=0.25) +
  geom_point(data=fib_all_res_F_res, aes(x = deltaEx_Fib, y = deltaEx), stroke=0, col="#00000060") +
geom_text(aes(x=1.5, y=-0.5, label=paste0("P = ",formatC(x=my.cor$p.value,digits=3),"\nr =",formatC(x=my.cor$estimate,digits=2))), size=2,hjust=1,vjust=0) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) + 
xlim(-0.5,2) + ylim(-0.5,2) +
  labs(x="deltaEx all samples", y="deltaEx female samples")
dev.off()


#plot fib all X vs male only
fib_all_res_M_res <- merge(x=fib_res,y=fib_male_res, by.x="gene_name.84",by.y="gene",all=TRUE)
#remove outliers
fib_all_res_M_res <- fib_all_res_M_res[!fib_all_res_M_res$Gene %in% c("BEX1"),]
my.deming <- deming(formula = deltaEx~deltaEx_Fib, data= fib_all_res_M_res)
my.cor <- cor.test(x = fib_all_res_M_res$deltaEx_Fib, y=fib_all_res_M_res$deltaEx, method="pearson")
pdf(file="fib_x_res_all_vs_M_only.pdf", width=2, height=2)
ggplot() +
  geom_vline(xintercept=0, size=0.25, lty=2, col="#00000040") +
  geom_hline(yintercept=0, size=0.25, lty=2, col="#00000040") +
  geom_abline(slope=my.deming$coefficients[2], intercept = my.deming$coefficients[1], size=0.25) +
  geom_point(data=fib_all_res_M_res, aes(x = deltaEx_Fib, y = deltaEx), stroke=0, col="#00000060") +
geom_text(aes(x=1.5, y=-0.5, label=paste0("P = ",formatC(x=my.cor$p.value,digits=3),"\nr =",formatC(x=my.cor$estimate,digits=2))), size=2,hjust=1,vjust=0) +
  theme_classic(base_size = 8) + theme(
      axis.text = element_text(color = "black"), 
      axis.ticks = element_line(color = "black", size = 0.25), 
      axis.line = element_line(size = 0.25),
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
      ) + 
  xlim(-0.5,2.05) + ylim(-0.5,2.05) +
  labs(x="deltaEx all samples", y="deltaEx male samples")
dev.off()
```
```{r}
sessionInfo()
```
